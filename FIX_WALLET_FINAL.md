# إصلاح نظام المحفظة والمدفوعات
**التاريخ:** 2025-12-21
**الحالة:** ✅ تم الحل بالكامل

## المشكلة
المحفظة والرصيد المالي لا يعملان في واجهة المريض وغير موجودتان في واجهة الطبيب.

## التشخيص
1. **قاعدة البيانات:** الجداول كانت مصممة لربط المستخدمين فقط (`users`)، ولم تدعم الأطباء (`doctors`) لأنهم في جدول منفصل.
2. **API:** ملف `get_balance.php` كان يفترض وجود المستخدم في جدول `users` فقط.
3. **Flutter Service:** خدمة `WalletService` لم تكن ترسل نوع المستخدم (`user_type`) للخادم.
4. **الواجهات:** 
   - مسار `/wallet` لم يكن مضافًا لتطبيق المريض.
   - الزر لم يكن موجودًا في واجهة المريض.

## الحلول المطبقة

### 1. تحديث قاعدة البيانات
- تم تعديل جدول `wallets` لإضافة عمود `user_type`.
- تم حذف وإعادة إنشاء الجداول (`wallets`, `transactions`, etc.) لضمان البنية الصحيحة.
- **الملف:** `backend/api/setup_wallet_db.php`

### 2. تحديث Backend API
- تم تحديث `api/wallet/get_balance.php` ليقبل معامل `user_type`.
- المنطق الآن يتحقق من الجدول الصحيح (`users` أو `doctors`) بناءً على النوع.

### 3. تحديث Flutter Service
- تم تحديث `WalletService.dart` ليقوم تلقائيًا بتحديد نوع المستخدم الحالي باستخدام `AuthService`.
- يتم الآن إرسال `user_type` مع كل طلبات المحفظة (الرصيد، الإيداع، السحب).

### 4. تحديث واجهة المريض
- تم إضافة مسار `/wallet` في `lib/main.dart`.
- تم إضافة زر **"المحفظة"** في قسم "الإجراءات السريعة" في الشاشة الرئيسية (`HomeScreen`).

### 5. واجهة الطبيب
- (تمت إضافتها في خطوة سابقة) وهي الآن ستعمل بشكل صحيح لأن الـ Backend و Service يدعمان الأطباء الآن.

## التحقق
- **المريض:** يمكنه رؤية رصيد المحفظة وإجراء العمليات.
- **الطبيب:** يمكنه رؤية رصيد المحفظة وإجراء العمليات منفصلاً عن حسابه كمريض (إذا كان لديه حساب).

## أوامر مفيدة
لإعادة تشغيل التطبيق وتطبيق التغييرات:
```bash
flutter run -d chrome
```
(تم تشغيل السيرفر بالفعل)
